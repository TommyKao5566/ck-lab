<html>

<head>
    <meta http-equiv=Content-Type content="text/html; charset=utf-8">
    <title></title>
    <script src="./ckeditor/ckeditor.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>

        const DEFAULT_PAGE_LINES = 25;
        const PAGE_COUNTS = 8;
        const PAGE_HEIGHT = 900
        const FONT_SIZE = 20

        const urlParams = new URLSearchParams(window.location.search);
        let pageLines = +(urlParams.get('pageLines')) || DEFAULT_PAGE_LINES;

        // line-height必定大於等於1，否則上下字體會重疊，難以閱讀
        // line-height >= 1
        // (line-height * pageLines * FONT_SIZE = PAGE_HEIGHT) >= pageLines * FONT_SIZE
        // PAGE_HEIGHT >= pageLines * FONT_SIZE
        // PAGE_HEIGHT / FONT_SIZE >= pageLines

        // 不滿足上面推導的情形，行數過多，會導致上下字體重疊，則設為預設行數
        if (pageLines > PAGE_HEIGHT / FONT_SIZE) {
            pageLines = DEFAULT_PAGE_LINES;
        }

        lineHeight = PAGE_HEIGHT / pageLines;

        //                                border bottom height = 1
        document.write(`<style>.my-page { height: ${PAGE_HEIGHT - 1}px; }</style>`);
    </script>
    <style>
        #cke_1_top {
            position: fixed;
            width: 914px;
            top: 42px;
        }

        #cke_1_contents {
            padding-top: 70px;
        }

        .my-page {
            border-bottom: 1px dotted black;
            display: flex;
        }

        .my-page::before {
            counter-increment: index;
            content: "〈第" counter(index, cjk-ideographic) "頁〉";
            margin-left: auto;
            /* 自動推到右邊 */
            margin-right: 25px;
            color: aquamarine;
        }

        #page-container {
            padding-top: 70px;
            position: absolute;
            top: 0;
            width: -webkit-fill-available;
            pointer-events: none;
            counter-reset: index;
            /* 初始化計數器 */
        }

        #hint {
            position: fixed;
            top: 0;
            z-index: 1;
            background: white;
            width: 935px;
            height: 42px;
        }
    </style>
</head>

<body lang=ZH-TW style='text-justify-trim:punctuation'>
    <center>
        <table border=0>
            <tr id="hint">
                <td align=left><b>作答區：(可切換輸入法進行輸入)</b>
                    <button onclick="
    const editorData = CKEDITOR.instances.content001.getData();
    localStorage.setItem('ckeditorContent', editorData);
    window.open('preview.html', 'CKEditorPreview', 'width=980,height=600');
">預覽</button>
                </td>
            </tr>

            <tr>
                <td style="position: relative;">
                    <textarea id='content001' name='content001'></textarea>
                    <div id="page-container">
                        <div class="my-page"></div>
                        <div class="my-page"></div>
                        <div class="my-page"></div>
                        <div class="my-page"></div>
                        <div class="my-page"></div>
                        <div class="my-page"></div>
                        <div class="my-page"></div>
                        <div class="my-page"></div>
                    </div>
                </td>
            </tr>
            <table>
    </center>
</body>
<script type='text/javascript'>
    if (window.navigator.userAgent.indexOf('Chrome') > -1) {
        let editor1;
        const editorHeight = PAGE_HEIGHT * PAGE_COUNTS; // Define editor height here

        if (null != document.getElementById('content001')) {
            //editor1 = CKEDITOR.replace('content001',{contentsCss : 'body {overflow:hidden;}'});
            editor1 = CKEDITOR.replace('content001', {
                height: editorHeight,
                contentsCss: ['./ckeditor/contents.css',
                    'data:text/css,' + encodeURIComponent(`
                        .cke_editable { font-size: ${FONT_SIZE}px; line-height: ${lineHeight / FONT_SIZE}; overflow-y: hidden; margin-top:0; margin-bottom:0;}
                    `)
                ]
            });
            CKEDITOR.instances['content001'].updateElement();

            editor1.on('key', function (evt) {
                if (evt.data.keyCode === 13) { // Enter key
                    if (this._isEnterKeyDown) { // Check if Enter is already held down
                        throw new Error("阻止連續的enter");
                    } else {
                        this._isEnterKeyDown = true; // Mark Enter as held down
                    }
                }
            });

            editor1.on('keyup', function (evt) {
                this._isEnterKeyDown = false; // Reset the flag
            });

            let initialData = '';
            for (let i = 1; i <= pageLines; i++) {
                initialData += `${i}<br>`;
            }
            initialData = initialData.repeat(PAGE_COUNTS);
            editor1.setData(initialData);
        }
    }

</script>
<script>
    (function () {
        let onTop = false;
        window.addEventListener('scroll', function () {
            // Check if the page has been scrolled down
            if (window.pageYOffset > 0) {
                // If it has been scrolled and the alert hasn't been shown yet
                if (!onTop) {
                    console.log('最外層scrollbar 不在最頂')
                    onTop = true; // Set the flag to true to prevent further alerts
                }
            } else {
                // If the user scrolls back to the very top, reset the flag
                console.log('最外層scrollbar 在最頂')
                onTop = false;
            }
        });
    })();
</script>

<script>

    // 定義一個判斷按鍵是否為上下左右箭頭或 Backspace 的函數
    function isAllowedKey(e) {
        const allowedKeys = [
            "ArrowUp",     // 上箭頭
            "ArrowDown",   // 下箭頭
            "ArrowLeft",   // 左箭頭
            "ArrowRight",  // 右箭頭
            "Backspace",   // Backspace 鍵
            "Delete"       // Delete 鍵
        ];

        return allowedKeys.includes(e.key);
    }

    (function () {
        const maxHeight = PAGE_COUNTS * PAGE_HEIGHT;
        let iframeDoc = null;

        // Function to check the height and show an alert
        function checkHeight(event) {
            // Do not trigger on Backspace or Delete
            if (event && isAllowedKey(event)) return;

            // A small timeout to let the DOM update after the event
            setTimeout(function () {
                if (!iframeDoc) return;
                const contentHeight = iframeDoc.body.scrollHeight;

                if (contentHeight > maxHeight) {
                    alert(`內容高度已超過 ${maxHeight}px，您剛才輸入的內容已被移除。`);
                    CKEDITOR.instances.content001.execCommand('undo');
                    // 避免使用者透過按鈕取消回上一步
                    CKEDITOR.instances.content001.resetUndo();
                }
            }, 100); // A small delay for rendering
        }

        // Wait for the editor's iframe to be created
        const initInterval = setInterval(function () {
            const editorIframe = document.querySelector('#cke_1_contents iframe');
            if (editorIframe && editorIframe.contentWindow && editorIframe.contentWindow.document) {
                iframeDoc = editorIframe.contentWindow.document;
                clearInterval(initInterval); // Stop polling

                // Attach event listeners as requested
                iframeDoc.addEventListener('keyup', checkHeight);
                iframeDoc.addEventListener('paste', checkHeight); // Also check on paste


                iframeDoc.addEventListener("keydown", function (e) {
                    const contentHeight = iframeDoc.body.scrollHeight;

                    if (isAllowedKey(e)) return;

                    if ((contentHeight > maxHeight)) {
                        e.preventDefault();
                    }
                });

            }
        }, 100);
    })();
</script>

</html>