<html>

<head>
    <meta http-equiv=Content-Type content="text/html; charset=utf-8">
    <title></title>
    <script src="./ckeditor/ckeditor.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const layout = urlParams.get('layout');

        const fontSize = 20
        let pageCount = 8;
        let lineHeight = 1.8 * fontSize;
        let pageLines = 25;

        switch (layout) {
            case 'A':
                pageLines = 20;
                lineHeight = 2.25 * fontSize;
                break;
            case 'B':
                pageLines = 25;
                lineHeight = 1.8 * fontSize
                break;
            case 'C':
                pageLines = 30;
                lineHeight = 1.5 * fontSize;
                break;

            default:
                break;
        }

        const myPageHeight = lineHeight * pageLines;
        document.write(`<style>.my-page { height: ${myPageHeight}px; }</style>`);
    </script>
    <style>
        #cke_1_top {
            position: fixed;
            width: 914px;
            top: 42px;
        }

        #cke_1_contents {
            padding-top: 70px;
        }

        .my-page {
            border-bottom: 1px dotted black;
            display: flex;
        }

        .my-page::before {
            counter-increment: index;
            content: "〈第" counter(index, cjk-ideographic) "頁〉";
            margin-left: auto;
            /* 自動推到右邊 */
            margin-right: 25px;
            color: aquamarine;
        }

        #page-container {
            padding-top: 70px;
            position: absolute;
            top: 0;
            width: -webkit-fill-available;
            pointer-events: none;
            counter-reset: index;
            /* 初始化計數器 */
        }

        #hint {
            position: fixed;
            top: 0;
            z-index: 1;
            background: white;
            width: 935px;
            height: 42px;
        }
    </style>
</head>

<body lang=ZH-TW style='text-justify-trim:punctuation'>
    <center>
        <table border=0>
            <tr id="hint">
                <td align=left><b>作答區：(可切換輸入法進行輸入)</b>
                    <button onclick="
    const editorData = CKEDITOR.instances.content001.getData();
    localStorage.setItem('ckeditorContent', editorData);
    window.open('preview.html', 'CKEditorPreview', 'width=980,height=600');
">預覽</button>
                </td>
            </tr>

            <tr>
                <td style="position: relative;">
                    <textarea id='content001' name='content001'></textarea>
                    <div id="page-container">
                        <div class="my-page"></div>
                        <div class="my-page"></div>
                        <div class="my-page"></div>
                        <div class="my-page"></div>
                        <div class="my-page"></div>
                        <div class="my-page"></div>
                        <div class="my-page"></div>
                        <div class="my-page"></div>
                    </div>
                </td>
            </tr>
            <table>
    </center>
</body>
<script type='text/javascript'>
    if (window.navigator.userAgent.indexOf('Chrome') > -1) {
        let editor1;
        const editorHeight = myPageHeight * pageCount + 10; // Define editor height here

        if (null != document.getElementById('content001')) {
            const contentsCss = `
            body { font-family: 細明體,新細明體,Arial,sans-serif,Verdana,標楷體,微軟正黑體; font-size: 12px; color: #333; background-color: #fff; margin: 20px; }
            p { margin: 0; }
            .cke_editable { font-size: ${fontSize}px; font-family:標楷體; line-height: ${lineHeight / fontSize}; letter-spacing:3pt; word-spacing:3pt; margin-top: 0; margin-bottom: 0; }
            blockquote { font-style: italic; font-family: Georgia, Times, "Times New Roman", serif; padding: 2px 0; border-style: solid; border-color: #ccc; border-width: 0; }
            a { color: #0782C1; }
            ol,ul,dl { margin: 0; padding: 0 40px; }
            h1,h2,h3,h4,h5,h6 { font-weight: normal; line-height: 1.2; }
            hr { border: 0px; border-top: 1px solid #ccc; }
            img.right { border: 1px solid #ccc; float: right; margin-left: 15px; padding: 5px; }
            img.left { border: 1px solid #ccc; float: left; margin-right: 15px; padding: 5px; }
            pre { white-space: pre-wrap; word-wrap: break-word; -moz-tab-size: 4; tab-size: 4; }
            .marker { background-color: Yellow; }
        `;
            //editor1 = CKEDITOR.replace('content001',{contentsCss : 'body {overflow:hidden;}'});
            editor1 = CKEDITOR.replace('content001', {
                height: editorHeight,
                contentsCss
            });
            CKEDITOR.instances['content001'].updateElement();

            let initialData = '';
            for (let i = 1; i <= pageLines; i++) {
                initialData += `${i}<br>`;
            }
            initialData = initialData.repeat(pageCount);
            editor1.setData(initialData);
        }
    }

</script>
<script>
    (function () {
        let onTop = false;
        window.addEventListener('scroll', function () {
            // Check if the page has been scrolled down
            if (window.pageYOffset > 0) {
                // If it has been scrolled and the alert hasn't been shown yet
                if (!onTop) {
                    console.log('最外層scrollbar 不在最頂')
                    onTop = true; // Set the flag to true to prevent further alerts
                }
            } else {
                // If the user scrolls back to the very top, reset the flag
                console.log('最外層scrollbar 在最頂')
                onTop = false;
            }
        });
    })();
</script>

<script>

    // 定義一個判斷按鍵是否為上下左右箭頭或 Backspace 的函數
    function isAllowedKey(e) {
    const allowedKeys = [
        "ArrowUp",     // 上箭頭
        "ArrowDown",   // 下箭頭
        "ArrowLeft",   // 左箭頭
        "ArrowRight",  // 右箭頭
        "Backspace",   // Backspace 鍵
        "Delete"       // Delete 鍵
    ];

        return allowedKeys.includes(e.key);
    }

    (function () {
        const maxHeight = pageCount * myPageHeight;
        let iframeDoc = null;

        // Function to check the height and show an alert
        function checkHeight(event) {
            // Do not trigger on Backspace or Delete
            if (event && isAllowedKey(event))  return;

            // A small timeout to let the DOM update after the event
            setTimeout(function () {
                if (!iframeDoc) return;
                const contentHeight = iframeDoc.body.scrollHeight;

                if (contentHeight > maxHeight) {
                    alert(`內容高度已超過 ${maxHeight}px，您剛才輸入的內容已被移除。`);
                    CKEDITOR.instances.content001.execCommand('undo');
                }
            }, 100); // A small delay for rendering
        }

        // Wait for the editor's iframe to be created
        const initInterval = setInterval(function () {
            const editorIframe = document.querySelector('#cke_1_contents iframe');
            if (editorIframe && editorIframe.contentWindow && editorIframe.contentWindow.document) {
                iframeDoc = editorIframe.contentWindow.document;
                clearInterval(initInterval); // Stop polling

                // Attach event listeners as requested
                iframeDoc.addEventListener('keyup', checkHeight);
                iframeDoc.addEventListener('paste', checkHeight); // Also check on paste


                iframeDoc.addEventListener("keydown", function (e) {
                    const contentHeight = iframeDoc.body.scrollHeight;
                    
                    if(isAllowedKey(e)) return;

                    if ((contentHeight > maxHeight)) {
                        e.preventDefault();
                    }
                });

            }
        }, 100);
    })();
</script>

</html>