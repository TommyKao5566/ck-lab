<html>

<head>
    <meta http-equiv=Content-Type content="text/html; charset=utf-8">
    <title></title>
    <script src="./ckeditor/ckeditor.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        #cke_1_top {
            position: fixed;
            width: 914px;
            top: 42px;
        }

        #cke_1_contents {
            padding-top: 70px;
        }

        .my-page {
            height: 900px;
            border-bottom: 1px dotted black;
            display: flex;
        }

        .my-page::before {
            counter-increment: index;
            content: "〈第" counter(index, cjk-ideographic) "頁〉";
            margin-left: auto;
            /* 自動推到右邊 */
            margin-right: 25px;
            color: aquamarine;
        }

        #page-container {
            padding-top: 70px;
            position: absolute;
            top: 0;
            width: -webkit-fill-available;
            pointer-events: none;
            counter-reset: index;
            /* 初始化計數器 */
        }

        #hint {
            position: fixed;
            top: 0;
            z-index: 1;
            background: white;
            width: 935px;
            height: 42px;
        }
    </style>
</head>

<body lang=ZH-TW style='text-justify-trim:punctuation'>
    <center>
        <table border=0>
            <tr id="hint">
                <td align=left><b>作答區：(可切換輸入法進行輸入)</b>
                    <button id="btn-capture-preview">擷取內容並下載多個圖片</button>
                    <button id="btn-capture-zip">擷取內容並下載為ZIP</button>
                </td>
            </tr>

            <tr>
                <td style="position: relative;">
                    <textarea id='content001' name='content001'></textarea>
                    <div id="page-container">
                        <div class="my-page"></div>
                        <div class="my-page"></div>
                        <div class="my-page"></div>
                        <div class="my-page"></div>
                        <div class="my-page"></div>
                        <div class="my-page"></div>
                        <div class="my-page"></div>
                        <div class="my-page"></div>
                    </div>
                </td>
            </tr>
            <table>
    </center>
</body>
<script type='text/javascript'>
    if (window.navigator.userAgent.indexOf('Chrome') > -1) {
        let editor1;
        if (null != document.getElementById('content001')) {
            //editor1 = CKEDITOR.replace('content001',{contentsCss : 'body {overflow:hidden;}'});
            editor1 = CKEDITOR.replace('content001');
            CKEDITOR.instances['content001'].updateElement();
            editor1.setData('1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>'.repeat(8));
        }
    }

</script>
<script>
    (function () {
        let onTop = false;
        window.addEventListener('scroll', function () {
            // Check if the page has been scrolled down
            if (window.pageYOffset > 0) {
                // If it has been scrolled and the alert hasn't been shown yet
                if (!onTop) {
                    console.log('最外層scrollbar 不在最頂')
                    onTop = true; // Set the flag to true to prevent further alerts
                }
            } else {
                // If the user scrolls back to the very top, reset the flag
                console.log('最外層scrollbar 在最頂')
                onTop = false;
            }
        });
    })();
</script>
<script>
    // --- Helper function to download a data URL ---
    function downloadDataUrl(dataUrl, filename) {
        const link = document.createElement('a');
        link.href = dataUrl;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // --- Main Capture Logic (used by both buttons) ---
    function captureEditorContent(callback) {
        const editor = CKEDITOR.instances.content001;
        if (!editor) {
            alert('Editor not found!');
            return;
        }

        const editorData = editor.getData();
        const editorContentCss = `
            body { font-family: 細明體,新細明體,Arial,sans-serif,Verdana,標楷體,微軟正黑體; font-size: 12px; color: #333; background-color: #fff; margin: 20px; }
            p { margin: 0; }
            .cke_editable { font-size: 20px; font-family:標楷體; line-height: 1.8; letter-spacing:3pt; word-spacing:3pt; }
            blockquote { font-style: italic; font-family: Georgia, Times, "Times New Roman", serif; padding: 2px 0; border-style: solid; border-color: #ccc; border-width: 0; }
            a { color: #0782C1; }
            ol,ul,dl { padding: 0 40px; }
            h1,h2,h3,h4,h5,h6 { font-weight: normal; line-height: 1.2; }
            hr { border: 0px; border-top: 1px solid #ccc; }
            img.right { border: 1px solid #ccc; float: right; margin-left: 15px; padding: 5px; }
            img.left { border: 1px solid #ccc; float: left; margin-right: 15px; padding: 5px; }
            pre { white-space: pre-wrap; word-wrap: break-word; -moz-tab-size: 4; tab-size: 4; }
            .marker { background-color: Yellow; }
        `;

        const renderContainer = document.createElement('div');
        renderContainer.style.position = 'absolute';
        renderContainer.style.left = '-9999px';
        renderContainer.style.width = (editor.container.getClientRect().width || 800) + 'px';
        renderContainer.style.border = '1px solid #ccc';
        renderContainer.style.backgroundColor = 'white';
        renderContainer.innerHTML = `<style>${editorContentCss}</style><div class="cke_editable">${editorData}</div>`;

        document.body.appendChild(renderContainer);

        html2canvas(renderContainer, { useCORS: true })
            .then(callback) // Pass the canvas to the callback function
            .catch(err => {
                console.error('Capture failed:', err);
                alert('圖片擷取失敗，請查看主控台以獲取詳細資訊。');
            })
            .finally(() => {
                document.body.removeChild(renderContainer);
            });
    }

    // --- Configuration ---
    const maxPagesToSave = 8; // Only save the first 8 pages.

    // --- Button 1: Download individual images ---
    document.getElementById('btn-capture-preview').addEventListener('click', function () {
        captureEditorContent(canvas => {
            const totalHeight = canvas.height;
            const chunkHeight = 900;
            const numChunks = Math.ceil(totalHeight / chunkHeight);
            const effectiveChunks = Math.min(numChunks, maxPagesToSave);

            function downloadChunk(chunkIndex) {
                if (chunkIndex >= effectiveChunks) return;

                const chunkCanvas = document.createElement('canvas');
                const chunkCtx = chunkCanvas.getContext('2d');
                const currentChunkHeight = Math.min(chunkHeight, totalHeight - (chunkIndex * chunkHeight));

                chunkCanvas.width = canvas.width;
                chunkCanvas.height = currentChunkHeight;

                chunkCtx.drawImage(canvas, 0, chunkIndex * chunkHeight, canvas.width, currentChunkHeight, 0, 0, canvas.width, currentChunkHeight);
                downloadDataUrl(chunkCanvas.toDataURL('image/png'), `editor-content-part-${chunkIndex + 1}.png`);

                setTimeout(() => downloadChunk(chunkIndex + 1), 500);
            }
            downloadChunk(0);
        });
    });

    // --- Button 2: Download as ZIP ---
    document.getElementById('btn-capture-zip').addEventListener('click', function () {
        captureEditorContent(canvas => {
            const zip = new JSZip();
            const totalHeight = canvas.height;
            const chunkHeight = 900;
            const numChunks = Math.ceil(totalHeight / chunkHeight);
            const effectiveChunks = Math.min(numChunks, maxPagesToSave);

            for (let i = 0; i < effectiveChunks; i++) {
                const chunkCanvas = document.createElement('canvas');
                const chunkCtx = chunkCanvas.getContext('2d');
                const currentChunkHeight = Math.min(chunkHeight, totalHeight - (i * chunkHeight));

                chunkCanvas.width = canvas.width;
                chunkCanvas.height = currentChunkHeight;

                chunkCtx.drawImage(canvas, 0, i * chunkHeight, canvas.width, currentChunkHeight, 0, 0, canvas.width, currentChunkHeight);

                const base64Data = chunkCanvas.toDataURL('image/png').split(',')[1];
                zip.file(`editor-content-part-${i + 1}.png`, base64Data, { base64: true });
            }

            zip.generateAsync({ type: "blob" }).then(blob => {
                const url = URL.createObjectURL(blob);
                downloadDataUrl(url, 'editor-content.zip');
                URL.revokeObjectURL(url); // Clean up
            });
        });
    });


</script>
    <script>
        (function() {
            const maxHeight = 7200;
            let iframeDoc = null;

            // Function to check the height and show an alert
            function checkHeight() {
                // A small timeout to let the DOM update after the event
                setTimeout(function() {
                    if (!iframeDoc) return;
                    const contentHeight = iframeDoc.body.scrollHeight;

                    if (contentHeight > maxHeight) {
                        alert(`內容高度已超過 ${maxHeight}px，請注意內容長度。`);
                    }
                }, 100); // A small delay for rendering
            }

            // Wait for the editor's iframe to be created
            const initInterval = setInterval(function() {
                const editorIframe = document.querySelector('#cke_1_contents iframe');
                if (editorIframe && editorIframe.contentWindow && editorIframe.contentWindow.document) {
                    iframeDoc = editorIframe.contentWindow.document;
                    clearInterval(initInterval); // Stop polling

                    // Attach event listeners as requested
                    iframeDoc.addEventListener('keyup', checkHeight);
                    iframeDoc.addEventListener('paste', checkHeight); // Also check on paste
                }
            }, 100);
        })();
    </script>

</html>